const t=window.JSZip,e="https://storage.googleapis.com/rebus-default-bucket/";function i(t){return t?t.textContent:""}function a(t,e){try{const i=new window.URL(e.opfPath,"http://example.com/");return new window.URL(t,i).pathname.replace("/","")}catch(t){return console.log(t.message),null}}function n(t){return t.activity={},-1!==t.mediaType.indexOf("image")?t.activity.type="Image":-1!==t.mediaType.indexOf("audio")?t.activity.type="Audio":-1!==t.mediaType.indexOf("video")?t.activity.type="Video":t.activity.type="Document",t.activity.url=[{type:"Link",href:t.href,rel:["alternate"],mediaType:t.mediaType}],t.summary=`Resource of type ${t.mediaType}`,t.activity["reader:path"]=t.path,t}function r(t){return new Promise((e,i)=>{try{const a=URL.createObjectURL(t),n=document.createElement("img");n.src=a,n.onload=(()=>{const t=n.width,i=n.height;return e({width:t,height:i})})}catch(t){i(t)}})}const o={load:async function(e={},i){const{base64:a=!1,file:n,DOMAIN:r}=i.detail;e.file=n,e.DOMAIN=r,e.zip=await t.loadAsync(n,{base64:a});const o=(await e.zip.file("META-INF/container.xml").async("string")).match(/full-path="([^"]+)"/);if(!o[1])throw new Error("No OPF path found");return e.opfPath=o[1],e.fileName=n.name,e},parse:async function(t){const r=new window.DOMParser,o=await t.zip.file(t.opfPath).async("string");let c=t.opf=r.parseFromString(o,"application/xml");c.querySelector("parsererror")?(c=t.opf=r.parseFromString(o,"text/html"),t.lang=i(c.querySelector("dc\\:language")),t.title=i(c.querySelector("dc\\:title"))):(t.lang=i(c.querySelector("language")),t.title=i(c.querySelector("title")));const l=c.querySelector("package"),s=l.getAttribute("unique-identifier");t.identifier=i(c.getElementById(s)),t.epubVersion=l.getAttribute("version");const p=c.querySelector("[properties~=nav]");if(p){const e=t.zip.file(decodeURI(a(p.getAttribute("href"),t)));t.htmlNav=e?await e.async("string"):null}if(!t.htmlNav){const e=c.querySelector("spine").getAttribute("toc"),i=a(c.getElementById(e).getAttribute("href"),t);t.ncx=await t.zip.file(decodeURI(i)).async("string")}function d(i){return new window.URL(t.bookPrefix+i,e)}t.bookPrefix=`${Math.random().toFixed(8).replace(".","")}/`,t.opfURL=d(t.opfPath),t.attachment=Array.from(c.querySelectorAll("item")).map(e=>{const i=a(e.getAttribute("href"),t);return{path:i,href:d(i).href,id:e.getAttribute("id"),properties:e.getAttribute("properties")||"",mediaType:e.getAttribute("media-type")}}).map(n);const m=Array.from(c.querySelectorAll('itemref:not([linear="no"])'));m.forEach((e,i)=>{t.attachment.filter(t=>t.id===e.getAttribute("idref"))[0].activity.position=i}),t.totalItems=m.length,t.attributedTo=Array.from(c.querySelectorAll("creator")).map(t=>({type:"Person",name:t.textContent}));const u=t.attachment.filter(t=>-1!==t.properties.indexOf("cover-image"))[0],h=c.querySelector('meta[name="cover"]'),f=c.querySelector('guide reference[type="cover"]'),y=c.querySelector("itemref");let g;if(u)g=u;else if(h)g=t.attachment.filter(t=>t.id===h.getAttribute("content"))[0];else if(f){const e=t.attachment.filter(e=>e.path===a(f.getAttribute("href"),t))[0];if(e&&-1!==e.mediaType.indexOf("image"))g=e;else if(e&&e.path){const i=await t.zip.file(decodeURI(e.path)).async("string"),a=r.parseFromString(i,"text/html").querySelector("img");if(a){const i=a.getAttribute("src"),n=new window.URL(i,e.href).href;g=t.attachment.filter(t=>t.href===n)[0]}}}else if(y){const e=t.attachment.filter(t=>t.id===y.getAttribute("idref"))[0];if(e&&e.path){const i=await t.zip.file(decodeURI(e.path)).async("string"),a=r.parseFromString(i,"text/html").querySelector("img");if(a){const i=a.getAttribute("src"),n=new window.URL(i,e.href).href;g=t.attachment.filter(t=>t.href===n)[0]}}}return g&&(t.cover=g),t.url=[{type:"Link",href:d(t.fileName),rel:["alternate"],mediaType:"application/epub+zip"}],t},process:async function(t,e){const a=t.zip,n=new window.DOMParser;for(var r=0;r<t.attachment.length;r++){const e=t.attachment[r];if("application/xhtml+xml"===e.mediaType){const t=await a.file(decodeURI(e.path)).async("string");e.activity.content=t;const r=n.parseFromString(t,"text/html"),o=i(r.querySelector("h1")),c=i(r.querySelector("h2")),l=i(r.querySelector("title"));e.activity.name=o||c||l}}return t},upload:async function(t,e){const i=window.uploadFile,a=t.zip;try{const e=new window.FormData,a=t.bookPrefix+t.file.name,n=new window.File([t.file],a,{type:"application/epub+zip"});console.log(n.name),e.append("file",n),e.append("name",a),await i(e)}catch(t){console.log(t.response)}for(var n=0;n<t.attachment.length;n++){const e=t.attachment[n],c=(o=e.mediaType).startsWith("image")?"Image":o.startsWith("audio")?"Audio":o.startsWith("video")?"Video":"text/html"===o?"html":"application/xhtml+xml"===o?"xhtml":"application/xml"===o?"xml":o.startsWith("text")?"generic-text":void 0,l=await a.file(decodeURI(e.path)).async("blob");let s;if("image"===c)try{s=await r(l),console.log(s)}catch(t){console.log(t)}const p=t.bookPrefix+decodeURI(e.path),d=new window.File([l],p,{type:e.mediaType}),m=new window.FormData;m.append("file",d),m.append("type",c),m.append("name",p);try{const t=await i(m);t.url&&(e.activity.url[0].href=t.url),s&&(e.activity.url[0].width=s.width,e.activity.url[0].height=s.height)}catch(t){console.log(t)}}var o;return t.cover&&t.cover.activity&&t.cover.activity.url&&t.cover.activity.url[0]&&(t.icon={type:"Image",summary:"EPUB Cover",url:t.cover.activity.url[0].href,mediaType:t.cover.mediaType}),t},create:async function(t,e){const i=window.createPublication,a={type:"reader:Publication",name:t.title};return a.attachment=t.attachment.map(t=>t.activity),a.totalItems=t.totalItems,a.attributedTo=t.attributedTo,t.icon&&(a.icon=t.icon),a.url=t.url,i({"@context":["https://www.w3.org/ns/activitystreams",{reader:"https://rebus.foundation/ns/reader",schema:"https://schema.org/"}],type:"Create",object:a})}};window.customElements.define("epub-import",class extends window.HTMLFormElement{connectedCallback(){this.addEventListener("change",this),this.fileInput=this.querySelector('input[type="file"]')}disconnectedCallback(){this.removeEventListener("change",this)}async handleEvent(t){const e=this.fileInput.files[0],i=this.querySelector("[data-upload-progress]");console.log(e.name),i.textContent=`Loading ${e.name}`;const a=this.querySelector("[data-upload-log]");try{const t=await o.load({},{detail:{file:e}});i.textContent=`Parsing ${t.title}`;const n=await o.parse(t);i.textContent=`Processing ${t.title}`;const r=await o.process(n);i.textContent=`Uploading media from ${t.title}`;const c=await o.upload(r);i.textContent=`Creating ${t.title}`;const l=await o.create(c);i.textContent="",console.log(l);const s=document.createElement("li");s.innerHTML=`${t.title} has been added to your library <span class="Import-checkmark">✔️</span>`,a.appendChild(s)}catch(t){console.log(t);const e=document.createElement("li");e.innerHTML=`<pre><code>${t.stack}</pre></code>`,a.appendChild(e)}}},{extends:"form"});
//# sourceMappingURL=importer.js.map
