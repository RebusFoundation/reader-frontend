!function(){var t={};const e=window.JSZip,i="https://storage.googleapis.com/rebus-default-bucket/";function a(t){return t?t.textContent:""}function n(t,e){try{const i=new window.URL(e.opfPath,"http://example.com/");return new window.URL(t,i).pathname.replace("/","")}catch(t){return console.log(t.message),null}}function r(t){return t.activity={},-1!==t.mediaType.indexOf("image")?t.activity.type="Image":-1!==t.mediaType.indexOf("audio")?t.activity.type="Audio":-1!==t.mediaType.indexOf("video")?t.activity.type="Video":t.activity.type="Document",t.activity.url=[{type:"Link",href:t.href,rel:["alternate"],mediaType:t.mediaType}],t.summary=`Resource of type ${t.mediaType}`,t.activity["reader:path"]=t.path,t}function o(t){return new Promise((e,i)=>{try{const a=URL.createObjectURL(t),n=document.createElement("img");n.src=a,n.onload=(()=>{const t=n.width,i=n.height;return e({width:t,height:i})})}catch(t){i(t)}})}function c(t){return t.startsWith("image")?"Image":t.startsWith("audio")?"Audio":t.startsWith("video")?"Video":"text/html"===t?"html":"application/xhtml+xml"===t?"xhtml":"application/xml"===t?"xml":t.startsWith("text")?"generic-text":void 0}t.actions={load:async function(t={},i){const{base64:a=!1,file:n,DOMAIN:r}=i.detail;t.file=n,t.DOMAIN=r,t.zip=await e.loadAsync(n,{base64:a});const o=(await t.zip.file("META-INF/container.xml").async("string")).match(/full-path="([^"]+)"/);if(!o[1])throw new Error("No OPF path found");return t.opfPath=o[1],t.fileName=n.name,t},parse:async function(t){const e=new window.DOMParser,o=await t.zip.file(t.opfPath).async("string");let c=t.opf=e.parseFromString(o,"application/xml");c.querySelector("parsererror")?(c=t.opf=e.parseFromString(o,"text/html"),t.lang=a(c.querySelector("dc\\:language")),t.title=a(c.querySelector("dc\\:title"))):(t.lang=a(c.querySelector("language")),t.title=a(c.querySelector("title")));const l=c.querySelector("package"),s=l.getAttribute("unique-identifier");t.identifier=a(c.getElementById(s)),t.epubVersion=l.getAttribute("version");const p=c.querySelector("[properties~=nav]");if(p){const e=t.zip.file(decodeURI(n(p.getAttribute("href"),t)));t.htmlNav=e?await e.async("string"):null}if(!t.htmlNav){const e=c.querySelector("spine").getAttribute("toc"),i=n(c.getElementById(e).getAttribute("href"),t);t.ncx=await t.zip.file(decodeURI(i)).async("string")}function d(e){return new window.URL(t.bookPrefix+e,i)}t.bookPrefix=`${Math.random().toFixed(8).replace(".","")}/`,t.opfURL=d(t.opfPath),t.attachment=Array.from(c.querySelectorAll("item")).map(e=>{const i=n(e.getAttribute("href"),t);return{path:i,href:d(i).href,id:e.getAttribute("id"),properties:e.getAttribute("properties")||"",mediaType:e.getAttribute("media-type")}}).map(r);const m=Array.from(c.querySelectorAll('itemref:not([linear="no"])'));m.forEach((e,i)=>{t.attachment.filter(t=>t.id===e.getAttribute("idref"))[0].activity.position=i}),t.totalItems=m.length,t.attributedTo=Array.from(c.querySelectorAll("creator")).map(t=>({type:"Person",name:t.textContent}));const u=t.attachment.filter(t=>-1!==t.properties.indexOf("cover-image"))[0],h=c.querySelector('meta[name="cover"]'),f=c.querySelector('guide reference[type="cover"]'),y=c.querySelector("itemref");let g;if(u)g=u;else if(h)g=t.attachment.filter(t=>t.id===h.getAttribute("content"))[0];else if(f){const i=t.attachment.filter(e=>e.path===n(f.getAttribute("href"),t))[0];if(i&&-1!==i.mediaType.indexOf("image"))g=i;else if(i&&i.path){const a=await t.zip.file(decodeURI(i.path)).async("string"),n=e.parseFromString(a,"text/html").querySelector("img");if(n){const e=n.getAttribute("src"),a=new window.URL(e,i.href).href;g=t.attachment.filter(t=>t.href===a)[0]}}}else if(y){const i=t.attachment.filter(t=>t.id===y.getAttribute("idref"))[0];if(i&&i.path){const a=await t.zip.file(decodeURI(i.path)).async("string"),n=e.parseFromString(a,"text/html").querySelector("img");if(n){const e=n.getAttribute("src"),a=new window.URL(e,i.href).href;g=t.attachment.filter(t=>t.href===a)[0]}}}return g&&(t.cover=g),t.url=[{type:"Link",href:d(t.fileName),rel:["alternate"],mediaType:"application/epub+zip"}],t},process:async function(t,e){const i=t.zip,n=new window.DOMParser;for(var r=0;r<t.attachment.length;r++){const e=t.attachment[r];if("application/xhtml+xml"===e.mediaType){const t=await i.file(decodeURI(e.path)).async("string");e.activity.content=t;const r=n.parseFromString(t,"text/html"),o=a(r.querySelector("h1")),c=a(r.querySelector("h2")),l=a(r.querySelector("title"));e.activity.name=o||c||l}}return t},upload:async function(t,e){const i=window.uploadFile,a=t.zip;try{const e=new window.FormData,a=t.bookPrefix+t.file.name,n=new window.File([t.file],a,{type:"application/epub+zip"});console.log(n.name),e.append("file",n),e.append("name",a),await i(e)}catch(t){console.log(t.response)}for(var n=0;n<t.attachment.length;n++){const e=t.attachment[n],r=c(e.mediaType),l=await a.file(decodeURI(e.path)).async("blob");let s;if("image"===r)try{s=await o(l),console.log(s)}catch(t){console.log(t)}const p=t.bookPrefix+decodeURI(e.path),d=new window.File([l],p,{type:e.mediaType}),m=new window.FormData;m.append("file",d),m.append("type",r),m.append("name",p);try{const a=await i(m);a.url&&(e.activity.url[0].href=a.url),s&&(e.activity.url[0].width=s.width,e.activity.url[0].height=s.height)}catch(t){console.log(t)}}return t.cover&&t.cover.activity&&t.cover.activity.url&&t.cover.activity.url[0]&&(t.icon={type:"Image",summary:"EPUB Cover",url:t.cover.activity.url[0].href,mediaType:t.cover.mediaType}),t},create:async function(t,e){const i=window.createPublication,a={type:"reader:Publication",name:t.title};return a.attachment=t.attachment.map(t=>t.activity),a.totalItems=t.totalItems,a.attributedTo=t.attributedTo,t.icon&&(a.icon=t.icon),a.url=t.url,i({"@context":["https://www.w3.org/ns/activitystreams",{reader:"https://rebus.foundation/ns/reader",schema:"https://schema.org/"}],type:"Create",object:a})}};const{actions:l}=t;window.customElements.define("epub-import",class extends window.HTMLFormElement{connectedCallback(){this.addEventListener("change",this),this.fileInput=this.querySelector('input[type="file"]')}disconnectedCallback(){this.removeEventListener("change",this)}async handleEvent(t){const e=this.fileInput.files[0],i=this.querySelector("[data-upload-progress]");console.log(e.name),i.textContent=`Loading ${e.name}`;const a=this.querySelector("[data-upload-log]");try{const n=await l.load({},{detail:{file:e}});i.textContent=`Parsing ${n.title}`;const r=await l.parse(n);i.textContent=`Processing ${n.title}`;const o=await l.process(r);i.textContent=`Uploading media from ${n.title}`;const c=await l.upload(o);i.textContent=`Creating ${n.title}`;const s=await l.create(c);i.textContent="",console.log(s);const p=document.createElement("li");p.innerHTML=`${n.title} has been added to your library <span class="Import-checkmark">✔️</span>`,a.appendChild(p)}catch(t){console.log(t);const e=document.createElement("li");e.innerHTML=`<pre><code>${t.stack}</pre></code>`,a.appendChild(e)}}},{extends:"form"})}();